<html>
  <head>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
    <!-- Load BodyPix -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>
    <script src="js/jquery-3.6.0.min.js"></script>

    <style>
      @font-face {
        font-family: Gotham-Bold;
        src: url(fonts/Gotham-Bold.otf);
      }
      @font-face {
        font-family: Gotham-Medium;
        src: url(fonts/Gotham-Medium.otf);
      }
      body {
        overflow: hidden;
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
      }
      #image {
        z-index: 1;
        position: absolute;
        top: 0px;
        height: 100vh;
        width: auto;
      }
      #video {
        z-index: 3;
        -moz-transform: scale(-1, 1);
        -webkit-transform: scale(-1, 1);
        -o-transform: scale(-1, 1);
        transform: scale(-1, 1);

        position: absolute;
        top: 0px;
        left: -1166px;
        height: 100vh;
        width: auto;
      }
      #canvas {
        z-index: 2;
        -moz-transform: scale(-1, 1);
        -webkit-transform: scale(-1, 1);
        -o-transform: scale(-1, 1);
        transform: scale(-1, 1);
        filter: FlipH;
        filter: grayscale(1);

        position: absolute;
        top: 0px;
        left: -1166px;
        height: 100vh;
        width: auto;
      }
      #container {
        position: fixed;
      }
      #countdownDisplay {
        z-index: 5;
        font-size: 200px;
        font-family: Gotham-Bold;
        position: absolute;
        left: 500px;
        top: 900px;
        color: white;
        background-color: RGBA(3, 252, 140, 0.8);
        display: none;
        border-radius: 50%;
        width: 200px;
        height: 200px;
        line-height: 200px;
        text-align: center;
        transform: translate(-50%, -50%);
      }
      #flashDiv {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100vw;
        height: 100vh;
        z-index: 4;
        background-color: white;
        opacity: 0;
      }
      #startButton {
        z-index: 4;
        font-size:100px;
        font-family: Gotham-Medium;
        position: absolute;
        width: 400px;
        height: 150px;
        line-height: 150px;
        left: 250px;
        top: 1795px;
        transform: translate(-50%, -50%);
        background-color: RGBA(237, 252, 242, 1);
        border-radius: 50px;
      }
      #thumb {
        z-index: 5;
        position: absolute;
        width: 300px;
        left: 250px;
        top: 1450px;
        transform: translate(-50%, -50%);
      }
    </style>
 </head>

  <body>
    <div id='container'>
      <div id="flashDiv"></div>
      <img id='image' src='images/West_Texas_Fair.jpg' crossorigin='anonymous'/>
      <video id="video" autoplay width='1920' height='1080'>
      </video>
      <canvas id="canvas" width='1920' height='1080'></canvas>
      <img id='thumb' src='thumbs/West_Texas_Fair.jpg'/>
      <button id="startButton" onclick="countdown(5, true);">Start</button>
      <span id="countdownDisplay">5</span>
    </div>
  </body>

  <script>
    const img = document.getElementById('image');
    const video = document.getElementById('video');
    const thumb = document.getElementById('thumb');
    const backgroundList = ["West_Texas_Fair.jpg"]

    const architecture = 'ResNet50'; // MobileNetV1 or ResNet50
    const multiplier = 1.0; // MobileNetV1 only - 0.5/0.75/1.0 smaller is faster
    const outputStride = 32; // 8,16 for MobileNetV1, 16,32 for ResNet50 (smaller is faster)
    const quantBytes = 4; // 1/2/4 (smaller is faster)
    const internalResolution = "full"; // low, medium, high, full
    const segmentationThreshold = 0.75; // [0,1]
    let net;

    async function loadAndPredict() {
      net = await bodyPix.load({
          architecture: architecture,
          outputStride: outputStride,
          multiplier: multiplier,
          quantBytes: quantBytes
      })
      .catch(error => {
          console.log(error);
      })
      .then(objNet => {
          net = objNet;
          cameraFrame = detectBody();
      });
    }

    function detectBody(){
      canvas = document.getElementById("canvas");
      ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0,0, canvas.width, canvas.height);
      net.segmentPerson(video,  {
          flipHorizontal: false,
          internalResolution: internalResolution,
          segmentationThreshold: segmentationThreshold
        })
      .catch(error => {
          console.log(error);
      })
      .then(personSegmentation => {
          flashOut();
          if(personSegmentation!=null){
              drawBody(personSegmentation);
          }
      });
    }

    function drawBody(personSegmentation) {

        canvas = document.getElementById("canvas");
        ctx = canvas.getContext('2d');
        ctx.drawImage(canvas, 0, 0, video.width, video.height);
        var imageData = ctx.getImageData(0,0, video.width, video.height);
        var pixel = imageData.data;
        for (var p = 0; p<pixel.length; p+=4)
        {
          if (personSegmentation.data[p/4] == 0) {
              pixel[p+3] = 0;
          }
        }
        ctx.imageSmoothingEnabled = true;
        ctx.putImageData(imageData,0,0);
        showStartButton();
      }

    var startWebcam = function () {

        var video = document.getElementById('video'),
            vendorUrl = window.URL || window.webkitURL;
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia(
              { video: {
                  width: { ideal: 1920},
                  height: { ideal: 1080}
                }
              }
            )
                .then(function (stream) {
                    video.srcObject = stream;
                }).catch(function (error) {
                    console.log("Something went wrong!");
                });
        }
    }

    function countdown(time=5, first=false) {
      if (first == true) {
        hideStartButton();
      }
      if (time > 1) {
        $("#countdownDisplay").animate({width:300, height: 300, lineHeight: 325, fontSize: 300}, 100);
        $("#countdownDisplay").animate({width:200, height: 200, lineHeight: 225, fontSize: 200}, 900);
      } else {
        $("#countdownDisplay").animate({width:300, height: 300, lineHeight: 300, fontSize: 300}, 100);
        $("#countdownDisplay").animate({width:0, height: 0, lineHeight: 0, fontSize: 0}, 900);
      }
      if (time > 0) {
        $(video).fadeIn(1)
        $("#countdownDisplay").html(time).show()

        document.getElementById("countdownDisplay").style.display = 'block';
        document.getElementById("countdownDisplay").innerHTML = time;
        setTimeout(function(){countdown(time-1)}, 1000);
      } else {
        $("#countdownDisplay").hide();
        takeSnapshot();
      }
    }

    function takeSnapshot() {
      // canvas = document.getElementById("canvas");
      // ctx = canvas.getContext('2d');
      // ctx.drawImage(video, 0,0, canvas.width, canvas.height);
      clearTimeout(fadeOutTimer);
      flashIn();
      $(video).fadeOut(40);
      loadAndPredict();
      fadeOutTimer = setTimeout(function(){$(video).fadeIn(40)}, 10000); // Re-show the camera
    }

    function flashIn() {

      // Create a flash effect over the screen

      // let out = function() {$("#flashDiv").animate({opacity: 0}, {duration: 500, queue: false})};
      $("#flashDiv").animate({opacity: 1},
                             {duration: 40, queue: false})
    }
    function flashOut() {

      // Create a flash effect over the screen

      $("#flashDiv").animate({opacity: 0}, {duration: 300, queue: false});
    }

    function hideStartButton() {

      // Animation to hide the start button

      // $("#startButton").prop("disabled", true);
      let contract = function() {
        $("#startButton").animate({width: 0, height: 0, opacity: 0, lineHeight: 0, fontSize: 0}, 500);
      };
      $("#startButton").animate({width: 440, height: 165, lineHeight: 165, fontSize: 110}, {duration: 100, complete: contract});
    }

    function showStartButton() {

      // Animation to show the start button

      // $("#startButton").prop("disabled", false);
      let contract = function() {
        $("#startButton").animate({width: 400, height: 150, lineHeight: 150, fontSize: 100}, 100);
      };
      $("#startButton").animate({width: 440, height: 165, lineHeight: 165, fontSize: 110, opacity: 1}, {duration: 500, complete: contract});
    }


    var fadeOutTimer;
    startWebcam();
    // loadAndPredict();
  </script>
</html>
