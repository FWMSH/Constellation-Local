<html>
  <head>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
    <!-- Load BodyPix -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>
 </head>

  <body>
    <img id='image' src='background.jpg' crossorigin='anonymous'/>
    <video id="video" autoplay height='480' width='640'>
    </video>
    <canvas id="canvas"></canvas>
  </body>
  <!-- Place your code in the script tag below. You can also use an external .js file -->
  <script>
    const img = document.getElementById('image');
    const video = document.getElementById('video');

    async function loadAndPredict() {
      const net = await bodyPix.load(/** optional arguments, see below **/);

      /**
       * One of (see documentation below):
       *   - net.segmentPerson
       *   - net.segmentPersonParts
       *   - net.segmentMultiPerson
       *   - net.segmentMultiPersonParts
       * See documentation below for details on each method.
       */
      const segmentation = await net.segmentPerson(video);
      // The mask image is an binary mask image with a 1 where there is a person and
      // a 0 where there is not.
      const coloredPartImage = bodyPix.toMask(segmentation);
      const opacity = 0.7;
      const flipHorizontal = false;
      const maskBlurAmount = 0;
      const edgeBlurAmount = 0;
      const backgroundBlurAmount = 5;
      const canvas = document.getElementById('canvas');
      // Draw the mask image on top of the original image onto a canvas.
      // The colored part image will be drawn semi-transparent, with an opacity of
      // 0.7, allowing for the original image to be visible under.
      // bodyPix.drawMask(
      //     canvas, video, coloredPartImage, opacity, maskBlurAmount,
      //     flipHorizontal);
      bodyPix.drawBokehEffect(
        canvas, video, segmentation, backgroundBlurAmount,
        edgeBlurAmount, flipHorizontal);

      loadAndPredict();
    }

    function drawBody(personSegmentation)
      {
          if(screenMode == 'l'){
              var canvas = document.createElement('canvas');
              canvas.width = webcamElement.width;
              canvas.height = webcamElement.height;
              var context = canvas.getContext('2d');
              context.drawImage(webcamElement, 0, 0);
              var imageData = context.getImageData(0,0, webcamElement.width, webcamElement.height);

              var pixel = imageData.data;
              for (var p = 0; p<pixel.length; p+=4)
              {
                if (personSegmentation.data[p/4] == 0) {
                    pixel[p+3] = 0;
                }
              }
              context.imageSmoothingEnabled = true;
              context.putImageData(imageData,0,0);

              var imageObject=new Image();
              imageObject.onload=function(){
                  contextPerson.clearRect(0,0,canvasPerson.width,canvasPerson.height);
                  contextPerson.imageSmoothingEnabled = true;
                  contextPerson.drawImage(imageObject, 0, 0, canvasPerson.width, canvasPerson.height);
              }
              imageObject.src=canvas.toDataURL();
          }else {
              contextPerson.drawImage(webcamElement, 0, 0, webcamElement.width, webcamElement.height);
              var imageData = contextPerson.getImageData(0,0, webcamElement.width, webcamElement.height);
              var pixel = imageData.data;
              for (var p = 0; p<pixel.length; p+=4)
              {
                if (personSegmentation.data[p/4] == 0) {
                    pixel[p+3] = 0;
                }
              }
              contextPerson.imageSmoothingEnabled = true;
              contextPerson.putImageData(imageData,0,0);
          }
      }

    var startWebcam = function () {
        var video = document.getElementById('video'),
            vendorUrl = window.URL || window.webkitURL;
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    video.srcObject = stream;
                }).catch(function (error) {
                    console.log("Something went wrong!");
                });
        }
    }
    startWebcam();
    // loadAndPredict();
  </script>
</html>
